name: Sample CI/CD - Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: sn0326-sandbox
  REGION: asia-northeast1
  SERVICE_NAME: sample-cicd-springboot-gcp
  REPOSITORY: sample-cicd-springboot-gcp

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Run tests
      run: mvn test
    
    - name: Build
      run: mvn clean package -DskipTests

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/886125133850/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'github-actions@sn0326-sandbox.iam.gserviceaccount.com'
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
    
    - name: Build and Push Docker image
      run: |
        IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}"
        IMAGE_TAG="${IMAGE_NAME}:${{ github.sha }}"
        IMAGE_LATEST="${IMAGE_NAME}:latest"
        
        docker build -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .
        docker push ${IMAGE_TAG}
        docker push ${IMAGE_LATEST}
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --platform=managed \
          --region=${{ env.REGION }} \
          --allow-unauthenticated \
          --memory=512Mi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=3 \
          --port=8080 \
          --labels=app=sample-cicd,framework=springboot,platform=gcp
    
    - name: Show Deployment Info
      run: |
        echo "=========================================="
        echo "ðŸš€ Deployment Complete!"
        echo "=========================================="
        echo "Application URL:"
        gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format='value(status.url)'
        echo ""
        echo "Test endpoints:"
        APP_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "  Home:   ${APP_URL}/"
        echo "  Health: ${APP_URL}/health"
        echo "  Info:   ${APP_URL}/info"
        echo "=========================================="