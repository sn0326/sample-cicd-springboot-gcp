<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ã§ã™ - Spring Boot Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .requirement-item {
            transition: all 0.2s ease;
        }
        .requirement-item.valid {
            color: #059669;
        }
        .requirement-item.invalid {
            color: #dc2626;
        }
        .strength-bar {
            transition: all 0.3s ease;
            height: 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-5 bg-gray-50">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-lg shadow-2xl p-10">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ã§ã™</h1>
            <p class="text-sm text-gray-600 text-center mb-2">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong th:text="${username}" id="currentUsername">User</strong>
            </p>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-6">
                <p class="text-sm text-yellow-700">
                    ä»®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™ã€‚<br>
                    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€æœ¬ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>

            <div th:if="${error}" class="bg-red-50 text-red-700 border border-red-200 rounded-md p-3 mb-5 text-sm">
                <span th:text="${error}">ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
            </div>

            <form th:action="@{/force-change-password}" method="post">
                <div class="mb-5">
                    <label for="newPassword" class="block mb-2 text-gray-800 font-medium text-sm">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="newPassword" name="newPassword" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-md text-sm focus:outline-none focus:border-slate-400 transition-colors">

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
                    <div class="mt-3 mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-medium text-gray-600">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦:</span>
                            <span id="strengthText" class="text-xs font-semibold">-</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="strengthBar" class="strength-bar bg-gray-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ãƒªã‚¹ãƒˆ -->
                    <div class="bg-gray-50 rounded-md p-3 mt-3">
                        <p class="text-xs font-semibold text-gray-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ï¼ˆNIST SP 800-63Bæº–æ‹ ï¼‰:</p>
                        <ul class="space-y-1 text-xs">
                            <li id="req-length" class="requirement-item flex items-center">
                                <span class="mr-2">â—‹</span>
                                <span>8æ–‡å­—ä»¥ä¸Š64æ–‡å­—ä»¥å†…</span>
                            </li>
                            <li id="req-username" class="requirement-item flex items-center">
                                <span class="mr-2">â—‹</span>
                                <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã¾ãªã„</span>
                            </li>
                            <li id="req-consecutive" class="requirement-item flex items-center">
                                <span class="mr-2">â—‹</span>
                                <span>åŒã˜æ–‡å­—ã‚’3æ–‡å­—ä»¥ä¸Šé€£ç¶šã•ã›ãªã„</span>
                            </li>
                            <li id="req-common" class="requirement-item flex items-center">
                                <span class="mr-2">â—‹</span>
                                <span>ä¸€èˆ¬çš„ãªå¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½¿ç”¨ä¸å¯</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="mb-5">
                    <label for="confirmPassword" class="block mb-2 text-gray-800 font-medium text-sm">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-md text-sm focus:outline-none focus:border-slate-400 transition-colors">
                    <p id="match-message" class="text-xs mt-1"></p>
                </div>

                <button type="submit" id="submitBtn" class="w-full py-3 bg-slate-700 text-white rounded-md text-base font-semibold hover:bg-slate-800 transition-colors cursor-pointer border-0">
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹
                </button>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        const username = /*[[${username}]]*/ 'user';

        // ä¸€èˆ¬çš„ãªå¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼‰
        const commonPasswords = [
            '12345678', '123456789', '1234567890', '00000000', '11111111',
            'password', 'password123', 'password1', 'passw0rd', 'p@ssw0rd', 'p@ssword',
            'qwerty', 'qwertyui', 'qwertyuiop', 'asdfghjk', 'asdfghjkl',
            'welcome', 'welcome1', 'admin', 'admin123', 'root', 'test', 'user',
            'letmein', 'monkey', 'dragon', 'master', 'iloveyou'
        ];

        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const matchMessage = document.getElementById('match-message');

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼é–¢æ•°
        function validatePassword(password) {
            const result = {
                length: password.length >= 8 && password.length <= 64,
                username: !password.toLowerCase().includes(username.toLowerCase()),
                consecutive: !hasConsecutiveChars(password, 3),
                common: !commonPasswords.includes(password.toLowerCase()),
                strength: calculateStrength(password)
            };
            return result;
        }

        // é€£ç¶šæ–‡å­—ãƒã‚§ãƒƒã‚¯
        function hasConsecutiveChars(password, maxCount) {
            let count = 1;
            for (let i = 1; i < password.length; i++) {
                if (password[i] === password[i - 1]) {
                    count++;
                    if (count > maxCount) return true;
                } else {
                    count = 1;
                }
            }
            return false;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦è¨ˆç®—
        function calculateStrength(password) {
            const length = password.length;
            if (length === 0) return 0;
            if (length < 8) return 1; // WEAK
            if (length < 10) return 1; // WEAK
            if (length < 12) return 2; // FAIR
            if (length < 16) return 3; // GOOD
            return 4; // STRONG
        }

        // UIæ›´æ–°é–¢æ•°
        function updateRequirement(id, valid) {
            const element = document.getElementById(id);
            const icon = element.querySelector('span:first-child');

            if (valid) {
                element.classList.add('valid');
                element.classList.remove('invalid');
                icon.textContent = 'âœ“';
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
                icon.textContent = 'âœ—';
            }
        }

        // å¼·åº¦ãƒãƒ¼æ›´æ–°
        function updateStrengthBar(strength) {
            const colors = ['#dc2626', '#ea580c', '#eab308', '#059669', '#047857'];
            const widths = [0, 25, 50, 75, 100];
            const labels = ['-', 'å¼±ã„', 'ã¾ã‚ã¾ã‚', 'è‰¯å¥½', 'å¼·ã„'];

            strengthBar.style.width = widths[strength] + '%';
            strengthBar.style.backgroundColor = colors[strength];
            strengthText.textContent = labels[strength];
            strengthText.style.color = colors[strength];
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;

            if (password.length === 0) {
                // ãƒªã‚»ãƒƒãƒˆ
                ['req-length', 'req-username', 'req-consecutive', 'req-common'].forEach(id => {
                    const element = document.getElementById(id);
                    element.classList.remove('valid', 'invalid');
                    element.querySelector('span:first-child').textContent = 'â—‹';
                });
                updateStrengthBar(0);
                return;
            }

            const validation = validatePassword(password);

            updateRequirement('req-length', validation.length);
            updateRequirement('req-username', validation.username);
            updateRequirement('req-consecutive', validation.consecutive);
            updateRequirement('req-common', validation.common);
            updateStrengthBar(validation.strength);

            // ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯
            checkPasswordMatch();
        });

        // ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¸€è‡´ãƒã‚§ãƒƒã‚¯
        function checkPasswordMatch() {
            const password = newPasswordInput.value;
            const confirm = confirmPasswordInput.value;

            if (confirm.length === 0) {
                matchMessage.textContent = '';
                matchMessage.className = 'text-xs mt-1';
                return;
            }

            if (password === confirm) {
                matchMessage.textContent = 'âœ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã™';
                matchMessage.className = 'text-xs mt-1 text-green-600';
            } else {
                matchMessage.textContent = 'âœ— ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';
                matchMessage.className = 'text-xs mt-1 text-red-600';
            }
        }

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    </script>
</body>
</html>
