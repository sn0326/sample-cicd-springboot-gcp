<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¹ã‚­ãƒ¼ç®¡ç† - Spring Boot Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center p-5 bg-gray-50">
    <div class="w-full max-w-3xl bg-white rounded-lg shadow-2xl overflow-hidden">
        <header class="bg-slate-800 text-white p-8 flex justify-between items-center flex-wrap">
            <h1 class="text-2xl font-bold mb-2.5">ğŸ” ãƒ‘ã‚¹ã‚­ãƒ¼ç®¡ç†</h1>
            <div class="flex items-center gap-4">
                <a th:href="@{/profile}" class="bg-white/20 text-white border border-white px-4 py-2 rounded-md cursor-pointer text-sm hover:bg-white/30 transition-colors no-underline">
                    ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸æˆ»ã‚‹
                </a>
                <a th:href="@{/home}" class="bg-white/20 text-white border border-white px-4 py-2 rounded-md cursor-pointer text-sm hover:bg-white/30 transition-colors no-underline">
                    ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
                </a>
            </div>
        </header>

        <main class="p-10">
            <div id="successMessage" class="bg-green-50 text-green-700 border border-green-200 rounded-md p-3 mb-5 text-sm hidden">
                <span id="successText"></span>
            </div>

            <div id="errorMessage" class="bg-red-50 text-red-700 border border-red-200 rounded-md p-3 mb-5 text-sm hidden">
                <span id="errorText"></span>
            </div>

            <div class="mb-8">
                <h2 class="text-gray-800 mb-4 text-2xl font-bold">ãƒ‘ã‚¹ã‚­ãƒ¼ã¨ã¯ï¼Ÿ</h2>
                <div class="bg-blue-50 p-5 rounded-lg mb-5">
                    <p class="text-gray-700 mb-3">
                        ãƒ‘ã‚¹ã‚­ãƒ¼ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä»£ã‚ã‚Šã«ç”Ÿä½“èªè¨¼ï¼ˆæŒ‡ç´‹ã€é¡”èªè¨¼ãªã©ï¼‰ã‚„ç”»é¢ãƒ­ãƒƒã‚¯ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã€ã‚ˆã‚Šå®‰å…¨ã§ä¾¿åˆ©ãªèªè¨¼æ–¹å¼ã§ã™ã€‚
                    </p>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦šãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“</li>
                        <li>ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒã«å¼·ã„</li>
                        <li>ãƒ‡ãƒã‚¤ã‚¹ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã‚‹</li>
                    </ul>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-gray-800 mb-4 text-2xl font-bold">ãƒ‘ã‚¹ã‚­ãƒ¼ã®çŠ¶æ…‹</h2>
                <div class="bg-gray-50 p-5 rounded-lg">
                    <p class="py-2 text-gray-700">
                        <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> <span th:text="${username}">user</span>
                    </p>
                    <p class="py-2 text-gray-700">
                        <strong>ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²çŠ¶æ…‹:</strong>
                        <span th:if="${hasPasskey}" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            âœ“ ç™»éŒ²æ¸ˆã¿
                        </span>
                        <span th:unless="${hasPasskey}" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                            æœªç™»éŒ²
                        </span>
                    </p>
                </div>
            </div>

            <div class="mb-8" th:unless="${hasPasskey}">
                <h2 class="text-gray-800 mb-4 text-2xl font-bold">ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ç™»éŒ²</h2>
                <p class="text-gray-600 mb-5">
                    ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                </p>
                <button id="registerPasskeyBtn"
                        class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹
                </button>
            </div>

            <div class="mb-8" th:if="${hasPasskey}">
                <h2 class="text-gray-800 mb-4 text-2xl font-bold">ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’å‰Šé™¤</h2>
                <p class="text-gray-600 mb-5">
                    ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ç”Ÿä½“èªè¨¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããªããªã‚Šã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã¯å¼•ãç¶šãåˆ©ç”¨ã§ãã¾ã™ã€‚
                </p>
                <button id="deletePasskeyBtn"
                        class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition-colors font-medium">
                    ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
                </button>
            </div>

            <div id="loadingIndicator" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl">
                    <div class="flex items-center space-x-3">
                        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-gray-700">å‡¦ç†ä¸­...</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const hasPasskey = /*[[${hasPasskey}]]*/ false;
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeaderName = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function showLoading(show) {
            if (show) {
                document.getElementById('loadingIndicator').classList.remove('hidden');
            } else {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Base64url ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰é–¢æ•°
        function base64urlToBuffer(base64url) {
            const padding = '='.repeat((4 - (base64url.length % 4)) % 4);
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + padding;
            const rawData = atob(base64);
            const buffer = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                buffer[i] = rawData.charCodeAt(i);
            }
            return buffer.buffer;
        }

        function bufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²å‡¦ç†
        async function registerPasskey() {
            try {
                showLoading(true);

                // Step 1: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const initResponse = await fetch('/passkey/register/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeaderName]: csrfToken
                    }
                });

                if (!initResponse.ok) {
                    throw new Error('ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const initData = await initResponse.json();

                // Step 2: WebAuthn APIã§ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const optionsResponse = await fetch('/webauthn/register/options', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeaderName]: csrfToken
                    },
                    body: JSON.stringify({
                        username: initData.username,
                        displayName: initData.displayName
                    })
                });

                if (!optionsResponse.ok) {
                    throw new Error('ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const options = await optionsResponse.json();

                // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                const publicKeyOptions = {
                    ...options,
                    user: {
                        ...options.user,
                        id: base64urlToBuffer(options.user.id)
                    },
                    challenge: base64urlToBuffer(options.challenge),
                    excludeCredentials: options.excludeCredentials?.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    })) || []
                };

                // Step 3: ãƒ–ãƒ©ã‚¦ã‚¶ã®ç”Ÿä½“èªè¨¼ã‚’å®Ÿè¡Œ
                const credential = await navigator.credentials.create({ publicKey: publicKeyOptions });

                // Step 4: ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’Spring SecurityãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«å¤‰æ›
                const credentialForServer = {
                    publicKey: {
                        credential: {
                            id: credential.id,
                            rawId: bufferToBase64url(credential.rawId),
                            response: {
                                attestationObject: bufferToBase64url(credential.response.attestationObject),
                                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                                transports: credential.response.getTransports ? credential.response.getTransports() : []
                            },
                            type: credential.type,
                            authenticatorAttachment: credential.authenticatorAttachment
                        },
                        label: initData.displayName || initData.username
                    }
                };

                // Step 5: ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                const registerResponse = await fetch('/webauthn/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeaderName]: csrfToken
                    },
                    body: JSON.stringify(credentialForServer)
                });

                if (!registerResponse.ok) {
                    throw new Error('ãƒ‘ã‚¹ã‚­ãƒ¼ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                showLoading(false);
                showSuccess('ãƒ‘ã‚¹ã‚­ãƒ¼ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');

            } catch (error) {
                console.error('ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                showLoading(false);
                showError(error.message || 'ãƒ‘ã‚¹ã‚­ãƒ¼ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒWebAuthnã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒ‘ã‚¹ã‚­ãƒ¼å‰Šé™¤å‡¦ç†
        async function deletePasskey() {
            if (!confirm('ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                showLoading(true);

                const response = await fetch('/passkey/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeaderName]: csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('ãƒ‘ã‚¹ã‚­ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                showLoading(false);
                showSuccess('ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

            } catch (error) {
                console.error('ãƒ‘ã‚¹ã‚­ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showLoading(false);
                showError('ãƒ‘ã‚¹ã‚­ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            const registerBtn = document.getElementById('registerPasskeyBtn');
            const deleteBtn = document.getElementById('deletePasskeyBtn');

            if (registerBtn) {
                registerBtn.addEventListener('click', registerPasskey);
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', deletePasskey);
            }

            // WebAuthnã‚µãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            if (!window.PublicKeyCredential) {
                showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Safariã€Edgeãªã©ã®æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        });
        /*]]>*/
    </script>
</body>
</html>
